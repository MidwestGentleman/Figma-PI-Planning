# PI Planning Templates - FigJam Plugin

A FigJam plugin that helps teams with PI (Program Increment) planning by providing templates for different ticket types, CSV import/export for Jira integration, and automatic card duplication detection.

## Features

### Template Types
- ðŸŽ¯ **Theme**: High-level business objectives with business value
- ðŸš€ **Initiative**: Strategic initiatives that span multiple epics
- ðŸ“… **Milestone**: Track key project milestones with target dates
- ðŸ—ï¸ **Epic**: Large work items that span multiple sprints
- ðŸ“‹ **User Story**: Standard user story format (As a/I want/So that)
- âœ… **Task**: Task items with story points and acceptance criteria
- ðŸ”¬ **Spike**: Research and investigation items
- ðŸ§ª **Test**: Test cases with Given/When/Then format

### Core Functionality
- **Template Insertion**: Quick access to all ticket type templates via tool pane
- **CSV Import**: Import Jira issues from CSV with automatic mapping to templates
- **CSV Export**: Export cards back to CSV format for round-trip to Jira
- **Issue Key Tracking**: Preserves Jira issue keys for imported cards
- **Duplication Detection**: Automatically detects and handles copied cards
- **Sprint Organization**: Groups imported issues by sprint with capacity tables
- **Epic Grouping**: Organizes cards by epic in columns

## Setup

### Prerequisites
- Node.js (v16 or higher)
- npm or yarn
- Figma Desktop app

### Installation

1. **Install Dependencies**
   ```bash
   npm install
   ```

2. **Build the Plugin**
   ```bash
   npm run build
   ```
   This uses `esbuild` to bundle all TypeScript modules into a single `code.js` file compatible with Figma's plugin runtime.

3. **Load in Figma**
   - Open Figma Desktop app
   - Go to `Menu > Plugins > Development > Import plugin from manifest...`
   - Select the `manifest.json` file in this directory
   - The plugin will appear in your plugins list

4. **Use in FigJam**
   - Open a FigJam file
   - Go to `Menu > Plugins > Development > PI Planning Templates`
   - The tool pane will open on the right side
   - Click on any template card to insert it into your board

## Development

### Build Scripts

- **Build**: `npm run build` - Compiles TypeScript and bundles with esbuild
- **Watch Mode**: `npm run watch` - Automatically rebuilds on file changes

### Project Structure

```
.
â”œâ”€â”€ manifest.json          # Plugin configuration (FigJam only)
â”œâ”€â”€ package.json           # Dependencies and build scripts
â”œâ”€â”€ tsconfig.json          # TypeScript compiler configuration
â”œâ”€â”€ ui.html                # Plugin UI (tool pane interface)
â”œâ”€â”€ code.js                # Bundled output (generated by build)
â””â”€â”€ src/
    â”œâ”€â”€ code.tsx           # Main plugin entry point and message handler
    â”œâ”€â”€ card-creation.ts   # Template card creation logic
    â”œâ”€â”€ config.ts          # Configuration constants (sizes, colors, timing)
    â”œâ”€â”€ templates.ts       # Template definitions
    â”œâ”€â”€ types.ts           # TypeScript type definitions
    â”œâ”€â”€ utils.ts           # Utility functions (validation, helpers)
    â””â”€â”€ figma.d.ts         # Figma API type definitions
```

### Architecture

The codebase is organized into modular TypeScript files:

- **`code.tsx`**: Main entry point that handles:
  - Message routing between UI and plugin
  - CSV parsing and import logic
  - CSV export generation
  - Card duplication detection
  - Sprint/epic organization

- **`card-creation.ts`**: Handles template card creation:
  - Frame creation and styling
  - Text node generation
  - Issue key storage in plugin data
  - Hyperlink creation for Jira links

- **`config.ts`**: Centralized configuration:
  - Card dimensions and spacing
  - Color schemes
  - Timing constants (delays, intervals)
  - UI configuration

- **`templates.ts`**: Template definitions with field structures

- **`types.ts`**: TypeScript interfaces and types:
  - `PluginMessage`: Discriminated union for message types
  - `Template`, `TemplateField`, `CardData`, `JiraIssue`

- **`utils.ts`**: Reusable utility functions:
  - Input validation
  - Font loading
  - Error handling
  - Field extraction helpers

### Build Process

The plugin uses `esbuild` to bundle all TypeScript modules into a single IIFE (Immediately Invoked Function Expression) format that Figma's plugin runtime can execute. The build process:

1. Bundles all imports into a single file
2. Outputs as IIFE format (no ES6 modules)
3. Targets ES2020 for browser compatibility
4. Removes the first line (which may contain unwanted directives)

### CSV Import/Export

#### Import Format
The plugin expects Jira CSV export format with columns like:
- `Issue key` - Required for round-trip tracking
- `Summary` - Maps to card title
- `Issue Type` - Maps to template type
- `Assignee` - Maps to assignee field
- `Custom field (Story Points)` - Maps to story points
- `Description` - Maps to description field
- And other Jira standard fields

#### Export Format
Exports include:
- `Summary` - Card title
- `Issue key` - Preserved from import (if available)
- `Issue Type` - Mapped from template type
- `Assignee` - Extracted from card
- `Custom field (Story Points)` - Extracted from card
- All other fields mapped to Jira CSV columns

#### Issue Key Tracking
- Imported cards store their issue key in plugin data
- Duplicated cards have their issue key removed (treated as new cards)
- Export includes issue keys for round-trip to Jira bulk import

### Duplication Detection

The plugin automatically detects when cards are copied:
- Runs on plugin load
- Monitors selection changes
- Periodically checks for duplicates
- Removes issue keys from duplicates
- Clears hyperlinks from duplicate titles
- Notifies users when duplicates are processed

## Customization

### Adding New Templates

1. **Add Template Definition** (`src/templates.ts`):
   ```typescript
   export const TEMPLATES = {
     // ... existing templates
     newTemplate: {
       title: "New Template",
       fields: [
         { label: "Field 1", value: "Default value" },
         { label: "Field 2", value: "Another value" }
       ]
     } as const,
   } as const;
   ```

2. **Add UI Card** (`ui.html`):
   ```html
   <div class="template-card" data-template="newTemplate">
     <div class="template-title">âœ¨ New Template</div>
     <div class="template-description">Description of the template</div>
     <div class="template-fields">Fields: Field 1, Field 2</div>
   </div>
   ```

3. **Update Type Definitions** (`src/types.ts`):
   - The `TemplateType` type will automatically include the new template via `keyof typeof TEMPLATES`

4. **Add Import Mapping** (`src/code.tsx`):
   - Update `mapJiraIssueToTemplate()` to map Jira issue types to your new template
   - Update `mapTemplateTypeToIssueType()` for export mapping

### Modifying Card Appearance

Edit `src/config.ts` to change:
- Card dimensions (`CARD_CONFIG`)
- Colors (`COLOR_CONFIG`)
- Spacing (`LAYOUT_CONFIG`)
- Font sizes and styles

### Adjusting Import Behavior

Modify `src/code.tsx`:
- `BATCH_SIZE`: Number of cards processed per batch
- `TIMING_CONFIG`: Delays and intervals for UI responsiveness
- `mapJiraIssueToTemplate()`: Customize Jira field mapping

## Best Practices

### FigJam Compatibility
- This plugin is designed specifically for FigJam (`editorType: ["figjam"]`)
- Uses FigJam-specific node types (FrameNode, StickyNode, etc.)
- Respects FigJam's native features (e.g., doesn't duplicate timer functionality)

### Performance
- Large CSV imports are processed in batches to prevent UI blocking
- Uses `yieldToUI()` to allow progress notifications
- Efficient lookups using `Set` and `Map` data structures

### Error Handling
- All async operations are wrapped in try-catch blocks
- User-friendly error messages via `figma.notify()`
- Console logging for debugging (non-verbose in production)

### Code Quality
- TypeScript strict mode enabled
- Modular architecture for maintainability
- Centralized configuration for easy updates
- Intelligent comments (not verbose)

## Troubleshooting

### Plugin Won't Load
- Ensure `code.js` exists (run `npm run build`)
- Check browser console for syntax errors
- Verify `manifest.json` is valid JSON

### Import Not Working
- Check CSV format matches Jira export format
- Verify "Issue key" column exists in CSV
- Check browser console for parsing errors

### Issue Keys Not Exporting
- Verify cards were imported (not manually created)
- Check console for warnings about issue key storage
- Ensure cards weren't duplicated (duplicates lose issue keys)

### Assignee Not Extracting
- Assignee is extracted from bottom-left of card
- Ensure card has assignee field (User Story, Task, Spike, Test)
- Check card layout matches template structure

## License

MIT
