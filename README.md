# PI Planning Templates - FigJam Plugin

A FigJam plugin that helps teams with PI (Program Increment) planning by providing templates for different ticket types, CSV import/export for Jira integration, and automatic card duplication detection.

## Features

### Template Types
- ğŸ¯ **Theme**: High-level business objectives with business value
- ğŸš€ **Initiative**: Strategic initiatives that span multiple epics
- ğŸ“… **Milestone**: Track key project milestones with target dates
- ğŸ—ï¸ **Epic**: Large work items that span multiple sprints
- ğŸ“‹ **User Story**: Standard user story format (As a/I want/So that)
- âœ… **Task**: Task items with story points and acceptance criteria
- ğŸ”¬ **Spike**: Research and investigation items
- ğŸ§ª **Test**: Test cases with Given/When/Then format

### Core Functionality
- **Template Insertion**: Quick access to all ticket type templates via tool pane
- **CSV Import**: Import Jira issues from CSV with automatic mapping to templates
- **CSV Export**: Export cards back to CSV format for round-trip to Jira
- **Issue Key Tracking**: Preserves Jira issue keys for imported cards
- **Duplication Detection**: Automatically detects and handles copied cards
- **Sprint Organization**: Groups imported issues by sprint with capacity tables
- **Epic Grouping**: Organizes cards by epic in columns

## Setup

### Prerequisites
- Node.js (v16 or higher)
- npm or yarn
- Figma Desktop app

### Installation

1. **Clone the Repository**
   ```bash
   git clone <repository-url>
   cd figma-pi-planning
   ```

2. **Install Dependencies**
   ```bash
   npm install
   ```
   **Note:** The `postinstall` script will automatically build `code.js` after installing dependencies. If you need to rebuild manually, run `npm run build`.

3. **Verify Build** (if needed)
   ```bash
   npm run build
   ```
   **Important:** The `code.js` file is not committed to git (it's a build artifact). The build step is automatically run after `npm install`, but you can rebuild manually if needed. This uses `esbuild` to bundle all TypeScript modules into a single `code.js` file compatible with Figma's plugin runtime.

4. **Load in Figma**
   - Open Figma Desktop app
   - Go to `Menu > Plugins > Development > Import plugin from manifest...`
   - Select the `manifest.json` file in this directory
   - The plugin will appear in your plugins list

4. **Use in FigJam**
   - Open a FigJam file
   - Go to `Menu > Plugins > Development > PI Planning Templates`
   - The tool pane will open on the right side
   - Click on any template card to insert it into your board

## Development

### Build Scripts

- **Build**: `npm run build` - Compiles TypeScript and bundles with esbuild
- **Watch Mode**: `npm run watch` - Automatically rebuilds on file changes

### Project Structure

```
.
â”œâ”€â”€ manifest.json          # Plugin configuration (FigJam only)
â”œâ”€â”€ package.json           # Dependencies and build scripts
â”œâ”€â”€ tsconfig.json          # TypeScript compiler configuration
â”œâ”€â”€ ui.html                # Plugin UI (tool pane interface)
â”œâ”€â”€ code.js                # Bundled output (generated by build)
â”œâ”€â”€ Deploy Docs/           # Deployment documentation
â””â”€â”€ src/
    â”œâ”€â”€ code.tsx           # Main plugin entry point and message handler
    â”œâ”€â”€ card-creation.ts   # Template card creation logic
    â”œâ”€â”€ config.ts          # Configuration constants (sizes, colors, timing)
    â”œâ”€â”€ templates.ts       # Template definitions
    â”œâ”€â”€ types.ts           # TypeScript type definitions
    â”œâ”€â”€ utils.ts           # Utility functions (validation, helpers)
    â”œâ”€â”€ errors.ts          # Structured error handling with error codes
    â”œâ”€â”€ logger.ts          # Centralized logging service
    â”œâ”€â”€ validation.ts      # Enhanced input validation and sanitization
    â”œâ”€â”€ resilience.ts      # Retry logic and resilience patterns
    â””â”€â”€ figma.d.ts         # Figma API type definitions
```

### Documentation

- **[Business Rules & Logic Report](./BUSINESS_RULES.md)** - Comprehensive guide to business rules, data models, workflows, and implementation rationale. Essential reading for developers new to the codebase to understand the "why" behind the code.

### Architecture

The codebase is organized into modular TypeScript files with enterprise-grade patterns:

- **`code.tsx`**: Main entry point that handles:
  - Message routing between UI and plugin
  - CSV parsing and import logic
  - CSV export generation
  - Card duplication detection
  - Sprint/epic organization
  - Uses structured error handling and centralized logging

- **`card-creation.ts`**: Handles template card creation:
  - Frame creation and styling
  - Text node generation
  - Issue key storage in plugin data
  - Hyperlink creation for Jira links
  - Structured logging for debugging

- **`config.ts`**: Centralized configuration:
  - Card dimensions and spacing
  - Color schemes
  - Timing constants (delays, intervals)
  - UI configuration
  - Validation limits

- **`templates.ts`**: Template definitions with field structures

- **`types.ts`**: TypeScript interfaces and types:
  - `PluginMessage`: Discriminated union for message types
  - `Template`, `TemplateField`, `CardData`, `JiraIssue`

- **`utils.ts`**: Reusable utility functions:
  - Font loading with caching
  - Field extraction helpers
  - Text manipulation utilities
  - Backward compatibility wrappers

- **`errors.ts`**: Enterprise error handling:
  - Structured error codes (`ErrorCode` enum)
  - `PluginError` class with context
  - Error extraction utilities
  - User-friendly error messages

- **`logger.ts`**: Centralized logging service:
  - Log levels (DEBUG, INFO, WARN, ERROR)
  - Memory-safe log storage (max 100 entries)
  - Structured logging with context
  - Console output with appropriate methods

- **`validation.ts`**: Enhanced input validation:
  - Comprehensive CSV validation
  - Jira URL validation and normalization
  - XSS prevention
  - Input sanitization
  - Coordinate validation

- **`resilience.ts`**: Resilience patterns:
  - Retry logic with exponential backoff
  - Timeout handling
  - Concurrency limiting
  - Circuit breaker pattern

### Build Process

The plugin uses `esbuild` to bundle all TypeScript modules into a single IIFE (Immediately Invoked Function Expression) format that Figma's plugin runtime can execute. The build process:

1. Bundles all imports into a single file
2. Outputs as IIFE format (no ES6 modules)
3. Targets ES2020 for browser compatibility
4. Removes the first line (which may contain unwanted directives)

### CSV Import/Export

#### Import Format
The plugin expects Jira CSV export format with columns like:
- `Issue key` - Required for round-trip tracking
- `Summary` - Maps to card title
- `Issue Type` - Maps to template type
- `Assignee` - Maps to assignee field
- `Custom field (Story Points)` - Maps to story points
- `Description` - Maps to description field
- And other Jira standard fields

#### Export Format
Exports include:
- `Summary` - Card title
- `Issue key` - Preserved from import (if available)
- `Issue Type` - Mapped from template type
- `Assignee` - Extracted from card
- `Custom field (Story Points)` - Extracted from card
- All other fields mapped to Jira CSV columns

#### Issue Key Tracking
- Imported cards store their issue key in plugin data
- Duplicated cards have their issue key removed (treated as new cards)
- Export includes issue keys for round-trip to Jira bulk import

### Duplication Detection

The plugin automatically detects when cards are copied:
- Runs on plugin load
- Monitors selection changes
- Periodically checks for duplicates
- Removes issue keys from duplicates
- Clears hyperlinks from duplicate titles
- Notifies users when duplicates are processed

## Customization

### Adding New Templates

1. **Add Template Definition** (`src/templates.ts`):
   ```typescript
   export const TEMPLATES = {
     // ... existing templates
     newTemplate: {
       title: "New Template",
       fields: [
         { label: "Field 1", value: "Default value" },
         { label: "Field 2", value: "Another value" }
       ]
     } as const,
   } as const;
   ```

2. **Add UI Card** (`ui.html`):
   ```html
   <div class="template-card" data-template="newTemplate">
     <div class="template-title">âœ¨ New Template</div>
     <div class="template-description">Description of the template</div>
     <div class="template-fields">Fields: Field 1, Field 2</div>
   </div>
   ```

3. **Update Type Definitions** (`src/types.ts`):
   - The `TemplateType` type will automatically include the new template via `keyof typeof TEMPLATES`

4. **Add Import Mapping** (`src/code.tsx`):
   - Update `mapJiraIssueToTemplate()` to map Jira issue types to your new template
   - Update `mapTemplateTypeToIssueType()` for export mapping

### Modifying Card Appearance

Edit `src/config.ts` to change:
- Card dimensions (`CARD_CONFIG`)
- Colors (`COLOR_CONFIG`)
- Spacing (`LAYOUT_CONFIG`)
- Font sizes and styles

### Adjusting Import Behavior

Modify `src/code.tsx`:
- `BATCH_SIZE`: Number of cards processed per batch
- `TIMING_CONFIG`: Delays and intervals for UI responsiveness
- `mapJiraIssueToTemplate()`: Customize Jira field mapping

## Best Practices

### FigJam Compatibility
- This plugin is designed specifically for FigJam (`editorType: ["figjam"]`)
- Uses FigJam-specific node types (FrameNode, StickyNode, etc.)
- Respects FigJam's native features (e.g., doesn't duplicate timer functionality)

### Performance
- Large CSV imports are processed in batches to prevent UI blocking
- Uses `yieldToUI()` to allow progress notifications
- Efficient lookups using `Set` and `Map` data structures

### Error Handling
- **Structured Error Handling**: Uses `PluginError` class with error codes and context
- **Centralized Logging**: All logging goes through `logger` service with appropriate levels
- **User-Friendly Messages**: Errors are extracted and formatted for user notifications
- **Retry Logic**: Critical operations (font loading) use retry with exponential backoff
- **Input Validation**: Comprehensive validation with security checks (XSS prevention)
- **Error Context**: All errors include context for better debugging

### Code Quality
- **TypeScript Strict Mode**: Full type safety enabled
- **Modular Architecture**: Clear separation of concerns
- **Enterprise Patterns**: Structured errors, centralized logging, resilience patterns
- **Security**: Input validation, XSS prevention, URL sanitization
- **Performance**: Batch processing, font caching, retry logic for reliability
- **Maintainability**: Well-organized modules with single responsibility
- **Figma Runtime Compatibility**: Figma's plugin runtime does not support optional chaining (`?.`). Use traditional null checks instead:
  ```typescript
  // âŒ Not supported
  const value = obj?.property?.trim() || '';
  
  // âœ… Use this instead
  const value = (obj && obj.property && obj.property.trim()) || '';
  ```

## Troubleshooting

### Plugin Won't Load
- **First step:** Ensure `code.js` exists (run `npm run build` after cloning)
- If you cloned the repo and the plugin doesn't work, you likely need to build it first
- Check browser console for syntax errors
- Verify `manifest.json` is valid JSON
- If you see an "older version" of the plugin, delete any existing `code.js` and rebuild with `npm run build`

### Import Not Working
- Check CSV format matches Jira export format
- Verify "Issue key" column exists in CSV
- Check browser console for detailed error messages (structured logging)
- Ensure CSV is valid UTF-8 encoding
- Check for CSV size limits (10MB maximum)
- Verify Jira URL format if using hyperlinks (accepts domain or full URL)

### Issue Keys Not Exporting
- Verify cards were imported (not manually created)
- Check browser console for structured error logs
- Ensure cards weren't duplicated (duplicates lose issue keys)
- Review logger output for detailed context

### Assignee Not Extracting
- Assignee is extracted from bottom-left of card
- Ensure card has assignee field (User Story, Task, Spike, Test)
- Check card layout matches template structure

## Deployment

Ready to publish your plugin to the Figma Community? See the deployment documentation in the `Deploy Docs/` folder:

- **[Quick Start Deployment](./Deploy%20Docs/QUICK_START_DEPLOYMENT.md)** - Get started in minutes
- **[Complete Deployment Guide](./Deploy%20Docs/DEPLOYMENT_GUIDE.md)** - Step-by-step instructions
- **[Deployment Checklist](./Deploy%20Docs/DEPLOYMENT_CHECKLIST.md)** - Ensure nothing is missed
- **[Asset Preparation Guide](./Deploy%20Docs/ASSET_PREPARATION_GUIDE.md)** - Create professional visuals
- **[Production Notes](./Deploy%20Docs/PRODUCTION_NOTES.md)** - Code quality and best practices

### Quick Deployment Steps

1. Enable 2FA on your Figma account (required)
2. Build plugin: `npm run build`
3. Create assets (icon, thumbnail)
4. Publish via Figma Desktop: `Plugins > Manage Plugins > Publish`
5. Wait 5-10 business days for review

See [QUICK_START_DEPLOYMENT.md](./Deploy%20Docs/QUICK_START_DEPLOYMENT.md) for details.

## License

MIT
